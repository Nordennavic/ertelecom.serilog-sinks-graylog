name: Push

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: 6.0.x
          
      - name: Restore dependencies
        run: dotnet restore ./src
      - name: Build
        run: dotnet build ./src --no-restore

      - name: Test
        run: dotnet test ./src --filter "FullyQualifiedName!~WhenCompressMessage&FullyQualifiedName!~WhenSendJson" --no-build --verbosity normal
  push-nuget:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: publish on version change
        id: publish_nuget
        uses: brandedoutcast/publish-nuget@v2
        with:
          PROJECT_FILE_PATH: ./src/Serilog.Sinks.Graylog/Serilog.Sinks.Graylog.csproj
          BUILD_CONFIGURATION: Release
          PACKAGE_NAME: ertelecom.Serilog.Sinks.Graylog
          VERSION_REGEX: ^\s*<Version>(.*)<\/Version>\s*$
          NUGET_KEY: ${{secrets.NUGET_API_KEY}}
